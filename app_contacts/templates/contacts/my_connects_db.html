{% extends "contacts/connects_base.html" %}
{% load static %}
{% block connect_content %}

<link rel="stylesheet" href="{% static 'app_contacts/css/my_connects_db.css' %}">
<script src="{% static 'app_contacts/js/my_connects_db.js' %}" defer></script>

<div class="glass-container">

    <!-- Profile -->
    <div class="glass-card profile-box">
        <div class="profile-left">
            <img src="{% if user.profile_picture %}{{ user.profile_picture.url }}{% else %}https://via.placeholder.com/130{% endif %}" class="profile-photo">
            <div>
                <h2>{{ user.full_name|default:user.username }}</h2>
                <p><i class="fa-solid fa-envelope"></i> {{ user.email }}</p>
                {% if user.phone %}
                <p><i class="fa-solid fa-phone"></i> {{ user.phone }}</p>
                {% endif %}
            </div>
        </div>

        <div id="counterBox" class="stat-vertical">
            <div class="stat-row">ğŸ“ Calls â€” <b id="callCount">{{ contact.calls|default_if_none:"0" }}</b></div>
            <div class="stat-row">âœ‰ Emails â€” <b id="emailCount">{{ contact.emails|default_if_none:"0" }}</b></div>
            <div class="stat-row">ğŸ“ Notes â€” <b id="noteCount">{{ notes.count|default_if_none:"0" }}</b></div>
        </div>
    </div>

    <!-- BUTTONS -->
    <div class="action-area">
        {% if user.phone %}<button class="neo-btn call" data-id="{{ contact.id }}">ğŸ“ Call</button>{% endif %}
        <button class="neo-btn email" data-id="{{ contact.id }}">âœ‰ Email</button>
        <button class="neo-btn note-toggle">ğŸ“ Notes</button>
        <button onclick="history.back()" class="neo-btn back">â¬… Back</button>
    </div>

    <!-- ğŸ”½ Notes Section -->
    <div id="noteSection" class="note-panel hidden">

        {% csrf_token %} <!-- THIS IS THE CORRECT PLACE ğŸ‘ˆ -->

        <textarea id="newNote" class="note-input" rows="3" placeholder="Write new note..."></textarea>
        <button id="saveNoteBtn" class="neo-btn save-note" data-id="{{ contact.id }}">ğŸ’¾ Save</button>

        <h4 class="mt-3">All Notes</h4>
        <div id="noteList">
            {% for n in notes %}
            <div class="note-item glass-card">
                <p>{{ n.text }}</p>
                <small>{{ n.created_at|date:"d M Y â€” h:i A" }}</small>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

{% endblock %}
