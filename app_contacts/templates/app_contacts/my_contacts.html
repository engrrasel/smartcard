{% extends "dashboard/dashboard_base.html" %}
{% load static %}

{% block content %}

<style>
.card-custom {
    border-radius: 16px;
    padding: 18px;
    background: #ffffff;
    border: 1px solid #eef0f3;
    display: flex;
    justify-content: space-between;
    align-items: center;
    transition: 0.18s;
}
.card-custom:hover { box-shadow: 0 10px 30px rgba(0,0,0,0.06); }

.contact-grid {
    display: flex;
    flex-direction: column;
    gap: 18px;
}
.card-avatar {
    width: 64px; height: 64px; border-radius: 50%; object-fit: cover;
}
.card-left { display: flex; align-items: center; gap: 12px; }
</style>

<div class="container mt-4">

    <!-- SEARCH BAR -->
    <div class="row mb-3">
        <div class="col-12 col-md-6 mx-auto">
            <input id="contactSearch" onkeyup="filterContacts()" class="form-control" placeholder="Search...">
        </div>
    </div>
    

    <!-- CONTACT LIST -->
   <div id="contactList" class="contact-grid">

{% for c in contacts %}

<div onclick="window.location='{% url 'app_contacts:contact_profile_db' c.visitor.id %}'"
     style="cursor:pointer;"
     class="card-custom contact-item"
     id="contact-{{ c.id }}">

    <div class="card-left">

        {% if c.visitor.profile_picture %}
        <img src="{{ c.visitor.profile_picture.url }}" class="card-avatar">
        {% else %}
        <img src="https://via.placeholder.com/64" class="card-avatar">
        {% endif %}

        <div>
            <h5>{{ c.visitor.full_name|default:c.visitor.username }}</h5>

            <p class="mb-0"><i class="fa-solid fa-envelope"></i> {{ c.visitor.email }}</p>

            {% if c.visitor.phone %}
            <p class="mb-0"><i class="fa-solid fa-phone"></i> {{ c.visitor.phone }}</p>
            {% endif %}

            <small class="text-muted">Added: {{ c.created_at|date:"d M Y, h:i A" }}</small>
        </div>

    </div>

    <!-- Delete Button -->
    <button class="btn btn-danger btn-sm"
            onclick="event.stopPropagation(); deleteContact({{ c.id }});">
        Delete
    </button>

</div>

{% endfor %}


    </div>

</div>

<!-- ALL SCRIPT MUST BE INSIDE BLOCK -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>

function filterContacts() {
    let q = document.getElementById('contactSearch').value.toLowerCase();
    let cards = document.getElementsByClassName('contact-item');

    for (let i = 0; i < cards.length; i++) {
        let text = cards[i].innerText.toLowerCase();
        cards[i].style.display = text.includes(q) ? "" : "none";
    }
}

function deleteContact(id){
    Swal.fire({
        title: "Are you sure?",
        text: "This will remove the contact permanently.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonColor: "#d33",
        cancelButtonColor: "#6c757d",
        confirmButtonText: "Delete"
    }).then((result) => {
        if (result.isConfirmed) {

            fetch(`/contacts/delete/${id}/`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    document.getElementById(`contact-${id}`).remove();
                    Swal.fire("Deleted!", "Contact removed.", "success");
                }
            });
        }
    });
}

</script>

{% endblock %}
