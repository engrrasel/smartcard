{% extends "base.html" %}
{% block content %}

<style>
body{
    background:#eef2ff;
    font-family:'Inter',sans-serif;
}
.profile-card{
    max-width:600px;margin:3rem auto;background:#fff;border-radius:18px;padding-bottom:15px;
    box-shadow:0 10px 25px rgba(0,0,0,.1);
}
.cover{
    background:linear-gradient(120deg,#007bff,#00d2ff);height:160px;
}
.avatar{
    width:120px;height:120px;border-radius:50%;border:5px solid #fff;margin-top:-60px;
}
.btn-area{
    display:flex;gap:10px;justify-content:center;margin:20px 0;
}
.btn-primary,.btn-call,.btn-save-contact{
    padding:9px 18px;color:#fff;border-radius:8px;font-weight:600;
}
.btn-primary{background:#0d6efd;}
.btn-call{background:#28a745;}
.btn-save-contact{background:#6c63ff;}
</style>


<div class="profile-card text-center">

    <div class="cover"></div>

    <img class="avatar" src="{{ profile.profile_picture.url|default:'https://via.placeholder.com/120' }}">

    <h2>{{ profile.full_name }}</h2>
    <p>{{ profile.job_title }}</p>
    <p>{{ profile.company_name }}</p>

    <div class="btn-area">
        <a onclick="clickTrack('connect')" class="btn-primary"
           href="{% url 'app_contacts:add_contact' profile.id %}">Connect</a>

        {% if profile.phone %}
        <a onclick="clickTrack('call')" class="btn-call" href="tel:{{ profile.phone }}">Call</a>
        {% endif %}

        <a onclick="clickTrack('save')" class="btn-save-contact"
           href="{% url 'app_accounts:download_contact_vcard' profile.username %}">Save</a>
    </div>

</div>


<script>
console.log("üî• PUBLIC PROFILE LOADED");  // DEBUG LINE

document.addEventListener("DOMContentLoaded", function () {

    const trackUrl = "{% url 'app_accounts:track_visit' profile.username %}";

    let visitLogged = false;
    let watchId = null;

    function sendVisit(lat, lon, acc){
        if (visitLogged) return;
        visitLogged = true;

        console.log("üì° Sending visit ‚Üí", lat, lon, "accuracy:", acc);

        fetch(
            trackUrl +
            "?lat=" + encodeURIComponent(lat) +
            "&lon=" + encodeURIComponent(lon) +
            "&accuracy=" + encodeURIComponent(acc),
            {
                method: "GET",
                credentials: "include",
                cache: "no-store",
                headers: { "Accept": "application/json" }
            }
        ).catch(err => console.log("Send error", err));
    }

    function fallbackIP(){
        if (visitLogged) return;
        visitLogged = true;

        console.log("üåç Fallback ‚Üí IP tracking");

        fetch(trackUrl, {
            method: "GET",
            credentials: "include",
            cache: "no-store",
            headers: { "Accept": "application/json" }
        }).catch(err => console.log("IP send error", err));
    }

    if (!navigator.geolocation){
        console.log("‚ùå Geolocation not supported ‚Üí Using IP");
        fallbackIP();
        return;
    }

    setTimeout(function () {
        if (!visitLogged){
            console.log("‚è± GPS timeout ‚Üí Using IP");
            if (watchId !== null){
                navigator.geolocation.clearWatch(watchId);
            }
            fallbackIP();
        }
    }, 8000);

    watchId = navigator.geolocation.watchPosition(
        pos => {
            console.log("üìç GPS update:", pos.coords);

            const lat = pos.coords.latitude;
            const lon = pos.coords.longitude;
            const acc = pos.coords.accuracy;

            if (!acc || acc > 350){
                console.log("‚ö† Bad accuracy:", acc, "waiting for better‚Ä¶");
                return;
            }

            if (acc <= 50){
                sendVisit(lat, lon, acc);
                navigator.geolocation.clearWatch(watchId);
            }
        },
        err => {
            console.log("‚ùå GPS error:", err);
            fallbackIP();
        },
        {
            enableHighAccuracy: true,
            maximumAge: 0,
            timeout: 10000
        }
    );

});
</script>

{% endblock %}
