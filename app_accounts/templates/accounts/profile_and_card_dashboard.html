{% extends "dashboard/dashboard_base.html" %}
{% load static %}

{% block title %}{{ profile.full_name }} ‚Äî Dashboard{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'accounts/css/click_analytics.css' %}">

<style>
    .tab-btn{
        padding:10px 22px;
        font-weight:600;
        border-radius:6px;
        border:none;
        cursor:pointer;
    }
    .tab-btn.active{
        background:#111;
        color:#fff;
    }
    .tab-btn.inactive{
        background:#e9e9e9;
        color:#333;
    }
    .tab-section{
        display:none;
        animation:fade .4s ease-in-out;
    }
    @keyframes fade{
        from{opacity:0}
        to{opacity:1}
    }
    .visitor-box{
        display:flex;
        align-items:center;
        gap:8px;
    }
    .visitor-box img{
        width:36px;
        height:36px;
        border-radius:50%;
        object-fit:cover;
        border:1px solid #ddd;
    }
</style>

<div class="container py-4">

    <h2 class="text-center fw-bold mb-4">üìä Button Click Analytics</h2>

    <!-- ================= SUMMARY BLOCK ================= -->
    <div class="row text-center mb-5">

        <div class="col-6 col-md-3">
            <div class="click-box">
                <h1>{{ click_stats.total|default:0 }}</h1>
                <small>Total Clicks</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="click-box text-primary">
                <h1>{{ click_stats.connect|default:0 }}</h1>
                <small>Connect</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="click-box text-success">
                <h1>{{ click_stats.save|default:0 }}</h1>
                <small>Saved</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="click-box text-danger">
                <h1>{{ click_stats.call|default:0 }}</h1>
                <small>Call</small>
            </div>
        </div>

    </div>

    <!-- ================= TAB HEADERS ================= -->
    <div class="text-center mb-4">
        <button class="tab-btn active" id="btn_logs"
                onclick="openTab('tab_logs','btn_logs')">
            üì• Recent Click Logs
        </button>

        <button class="tab-btn inactive" id="btn_loc"
                onclick="openTab('tab_loc','btn_loc')">
            üåç Visitor Locations
        </button>
    </div>

    <!-- ================= TAB - CLICK LOGS ================= -->
    <div id="tab_logs" class="tab-section" style="display:block">
        <h4 class="text-center fw-bold mb-3">üì• Recent Click Logs (Last 50)</h4>

        <div class="log-box">
            <table class="table table-hover">
                <thead class="table-light">
                    <tr>
                        <th>Button</th>
                        <th>IP</th>
                        <th>Device</th>
                        <th>Time</th>
                    </tr>
                </thead>
                <tbody>
                {% for c in click_logs %}
                    <tr>
                        <td><span class="badge bg-primary">{{ c.button_type }}</span></td>
                        <td>{{ c.device_ip }}</td>
                        <td>{{ c.user_agent|truncatechars:25 }}</td>
                        <td>{{ c.timestamp|date:"d M ‚Ä¢ h:i A" }}</td>
                    </tr>
                {% empty %}
                    <tr>
                        <td colspan="4" class="text-center text-muted py-3">No Click Data</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

<!-- ================= TAB - LOCATION LOGS ================= -->
<div id="tab_loc" class="tab-section">
    <h4 class="text-center fw-bold mb-3">üåç Visitor Location Logs</h4>

    <table class="table table-striped mt-3">
        <thead class="table-dark">
            <tr>
                <th>Visitor</th> <!-- FIRST COLUMN -->
                <th>Country</th>
                <th>City / District</th>
                <th>Thana</th>
                <th>Post Office</th>
                <th>Lat</th>
                <th>Lon</th>
                <th>Time</th>
                <th>Accuracy %</th>
                <th>Source</th>
            </tr>
        </thead>

        <tbody>
        {% for v in location_logs %}
            <tr>

                <!-- VISITOR COLUMN FIRST -->
                <td>
                    {% if v.visitor %}
                        <div class="visitor-box">

                            {% if v.visitor.profile_picture %}
                                <img src="{{ v.visitor.profile_picture.url }}" alt="visitor">
                            {% else %}
                                <img src="https://via.placeholder.com/36" alt="visitor">
                            {% endif %}

                            <div>
                                <div>{{ v.visitor.full_name|default:v.visitor.email }}</div>
                                <small class="text-muted">{{ v.visitor.username }}</small>
                            </div>
                        </div>

                    {% else %}
                        <span class="text-muted">Anonymous</span>
                    {% endif %}
                </td>


                <td>{{ v.country|default:"-" }}</td>
                <td>{{ v.city|default:"-" }}</td>
                <td>{{ v.thana|default:"-" }}</td>
                <td>{{ v.post_office|default:"-" }}</td>
                <td>{{ v.latitude|default:"-" }}</td>
                <td>{{ v.longitude|default:"-" }}</td>
                <td>{{ v.timestamp|date:"d M h:i A" }}</td>

                <td><b>{{ v.accuracy|default:"-" }}%</b></td>

                <td>
                    {% if v.location_source == "GPS" %}
                        <span class="badge bg-success">GPS</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">IP</span>
                    {% endif %}
                </td>

            </tr>
        {% empty %}
            <tr>
                <td colspan="10" class="text-center text-muted py-3">
                    No location found
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>


</div>

<script>
function openTab(sectionId, btnId){
    document.querySelectorAll('.tab-section').forEach(el => el.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('inactive');
    });

    const activeBtn = document.getElementById(btnId);
    activeBtn.classList.remove('inactive');
    activeBtn.classList.add('active');
}
</script>

{% endblock %}
