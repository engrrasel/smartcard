{% extends "dashboard/dashboard_base.html" %}
{% load static %}

{% block title %}{{ profile.full_name }} ‚Äî Dashboard{% endblock %}

{% block content %}

<link rel="stylesheet" href="{% static 'accounts/css/click_analytics.css' %}">

<style>
    .tab-container{
        display:flex;
        justify-content:space-between;
        align-items:center;
        margin-bottom:18px;
        flex-wrap:wrap;
        gap:10px;
    }
    .tab-left{
        display:flex;
        gap:10px;
    }
    .tab-btn{
        padding:8px 16px;
        font-weight:600;
        border-radius:6px;
        border:1px solid #ccc;
        cursor:pointer;
        background:#f8f9fa;
    }
    .tab-btn.active{
        background:#111;
        color:#fff;
        border-color:#111;
    }
    .search-box{
        max-width:260px;
        width:100%;
    }
    .search-box input{
        width:100%;
        padding:8px 14px;
        border-radius:6px;
        border:1px solid #bbb;
    }
    .tab-section{
        display:none;
        animation:fade .4s ease-in-out;
    }
    @keyframes fade{from{opacity:0} to{opacity:1}}

    .visitor-box{
        display:flex;
        align-items:center;
        gap:8px;
    }
    .visitor-box img{
        width:36px;
        height:36px;
        border-radius:50%;
        object-fit:cover;
        border:1px solid #ddd;
    }
</style>

<div class="container py-4">

    <h2 class="text-center fw-bold mb-4">üìä Button Click Analytics</h2>

    <!-- ================= SUMMARY BLOCK ================= -->
    <div class="row text-center mb-5">

        <div class="col-6 col-md-3">
            <div class="click-box">
                <h1>{{ click_stats.total|default:0 }}</h1>
                <small>Total Clicks</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="click-box text-primary">
                <h1>{{ click_stats.connect|default:0 }}</h1>
                <small>Connect</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="click-box text-success">
                <h1>{{ click_stats.save|default:0 }}</h1>
                <small>Saved</small>
            </div>
        </div>

        <div class="col-6 col-md-3">
            <div class="click-box text-danger">
                <h1>{{ click_stats.call|default:0 }}</h1>
                <small>Call</small>
            </div>
        </div>

    </div>

    <!-- =============== TABS + SEARCHBAR (NEW UI) =============== -->
    <div class="tab-container">

        <!-- LEFT BUTTONS -->
        <div class="tab-left">
            <button class="tab-btn active" id="btn_loc"
                onclick="openTab('tab_loc','btn_loc')">
                üåç Visitor Locations
            </button>

            <button class="tab-btn inactive" id="btn_logs"
                onclick="openTab('tab_logs','btn_logs')">
                üì• Click Logs
            </button>
        </div>

        <!-- RIGHT SEARCH BAR -->
        <div class="search-box">
            <input type="text" id="searchInput" placeholder="Search visitors, country, city‚Ä¶"
                   onkeyup="searchTable()">
        </div>

    </div>


<!-- ========================================================= -->
<!-- ================= TAB - LOCATION LOGS (DEFAULT) ============ -->
<!-- ========================================================= -->
<div id="tab_loc" class="tab-section" style="display:block;">

    <table class="table table-striped mt-3" id="visitorTable">
        <thead class="table-dark">
            <tr>
                <th>Visitor</th>
                <th>Country</th>
                <th>City / District</th>
                <th>Thana</th>
                <th>Post Office</th>
                <th>Lat</th>
                <th>Lon</th>
                <th>Time</th>
                <th>Accuracy %</th>
                <th>Source</th>
            </tr>
        </thead>

        <tbody>
        {% for v in location_logs %}
            <tr>
                <td>
                    {% if v.visitor %}
                        <div class="visitor-box">
                            <img src="{{ v.visitor.profile_picture.url|default:'https://via.placeholder.com/36' }}">
                            <div>
                                <div>{{ v.visitor.full_name|default:v.visitor.email }}</div>
                                <small class="text-muted">{{ v.visitor.username }}</small>
                            </div>
                        </div>
                    {% else %}
                        Anonymous
                    {% endif %}
                </td>

                <td>{{ v.country|default:"-" }}</td>
                <td>{{ v.city|default:"-" }}</td>
                <td>{{ v.thana|default:"-" }}</td>
                <td>{{ v.post_office|default:"-" }}</td>
                <td>{{ v.latitude|default:"-" }}</td>
                <td>{{ v.longitude|default:"-" }}</td>
                <td>{{ v.timestamp|date:"d M h:i A" }}</td>

                <td><b>{{ v.accuracy|default:"-" }}%</b></td>

                <td>
                    {% if v.location_source == "GPS" %}
                        <span class="badge bg-success">GPS</span>
                    {% else %}
                        <span class="badge bg-warning text-dark">IP</span>
                    {% endif %}
                </td>

            </tr>
        {% endfor %}
        </tbody>
    </table>

</div>


<!-- ========================================================= -->
<!-- ================= TAB - CLICK LOGS ============ -->
<!-- ========================================================= -->
<div id="tab_logs" class="tab-section">

    <table class="table table-hover" id="clickTable">
        <thead class="table-light">
            <tr>
                <th>Button</th>
                <th>IP</th>
                <th>Device</th>
                <th>Time</th>
            </tr>
        </thead>

        <tbody>
        {% for c in click_logs %}
            <tr>
                <td>
                    {% if c.action %}
                        <span class="badge bg-primary">{{ c.action }}</span>
                    {% else %}
                        <span class="text-muted">-</span>
                    {% endif %}
                </td>

                <td>{{ c.device_ip }}</td>
                <td>{{ c.user_agent|truncatechars:25 }}</td>
                <td>{{ c.timestamp|date:"d M ‚Ä¢ h:i A" }}</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

</div>


</div>

<script>
function openTab(sectionId, btnId){
    document.querySelectorAll('.tab-section').forEach(el => el.style.display = 'none');
    document.getElementById(sectionId).style.display = 'block';

    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('active');
        btn.classList.add('inactive');
    });

    const activeBtn = document.getElementById(btnId);
    activeBtn.classList.remove('inactive');
    activeBtn.classList.add('active');
}

/* üî• UNIVERSAL SEARCH ‚Äî works on both tables */
function searchTable(){
    let input = document.getElementById("searchInput").value.toLowerCase();

    let visitorRows = document.querySelectorAll("#visitorTable tbody tr");
    visitorRows.forEach(row=>{
        let text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });

    let clickRows = document.querySelectorAll("#clickTable tbody tr");
    clickRows.forEach(row=>{
        let text = row.innerText.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
}
</script>

{% endblock %}
